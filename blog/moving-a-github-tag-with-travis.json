{"id":"https://contentapi.theodi.org/moving-a-github-tag-with-travis.json","web_url":"http://theodi.org/blog/moving-a-github-tag-with-travis","slug":"moving-a-github-tag-with-travis","title":"Moving a Github tag with Travis","format":"article","updated_at":"2015-09-11T09:53:51+00:00","created_at":"2013-12-17T15:04:49+00:00","tag_ids":["blog"],"tags":[{"id":"https://contentapi.theodi.org/tags/articles/blog.json","web_url":null,"title":"Blog Post","details":{"description":"Blog Post","type":"article"},"content_with_tag":{"id":"https://contentapi.theodi.org/with_tag.json?article=blog","web_url":"http://theodi.org/tags/blog","slug":"blog"}}],"details":{"business_proposition":false,"description":"","excerpt":"In the ODI tech team, we are deeply devoted followers of the dual canons of Continuous Integration and Continuous Deployment. This means that once our code is pushed into Github, we run the tests on our [Jenkins server](http://jenkins.theodi.org), and if the tests pass on the master branch, it moves a Github tag called CURRENT to that point. Our Chef server then picks it up and deploys the code to production. No humans are involved in the process. It's robots all the way down.\r","language":"en","need_extended_font":false,"alternative_title":"","url":"","content":"<p>In the ODI tech team, we are deeply devoted followers of the dual canons of Continuous Integration and Continuous Deployment. This means that once our code is pushed into Github, we run the tests on our <a href=\"http://jenkins.theodi.org\">Jenkins server</a>, and if the tests pass on the <em>master</em> branch, it moves a Github tag called <em>CURRENT</em> to that point. Our Chef server then picks it up and deploys the code to production. No humans are involved in the process. It's robots all the way down.</p>\n<p>We've recently been experimenting with using <a href=\"https://travis-ci.org/\">Travis-CI</a> to run our tests, and wanted to know if we could do the same thing using Travis.</p>\n<p>Turns out we can, but it involves a certain amount of hoop-jumping. Presuming you've got your project currently building in Travis, the steps are:</p>\n<p>Encrypt your Github login (from inside your local repo):</p>\n<pre><code>travis login\ntravis encrypt GITHUB_USER=odi-robot\ntravis encrypt GITHUB_PASSWORD=thisisareallyreallylonggithubpassword\n</code></pre>\n<p>This will give you a couple of strings, which you need to paste into your <em>.travis.yml</em> to make it look like this:</p>\n<pre><code>---\nafter_success:\n  - \"[ \\\"$TRAVIS_BRANCH\\\" == \\\"master\\\" ] &amp;&amp; curl -v -X DELETE -u $GITHUB_USER:$GITHUB_PASSWORD \\\"https://api.github.com/repos/$TRAVIS_REPO_SLUG/git/refs/tags/CURRENT\\\"\"\n  - \"[ \\\"$TRAVIS_BRANCH\\\" == \\\"master\\\" ] &amp;&amp; curl -v -X POST -d '{\\\"ref\\\":\\\"refs/tags/CURRENT\\\",\\\"sha\\\":\\\"'$TRAVIS_COMMIT'\\\"}' --header \\\"Content-Type:application/json\\\" -u $GITHUB_USER:$GITHUB_PASSWORD \\\"https://api.github.com/repos/$TRAVIS_REPO_SLUG/git/refs\\\"\"\nenv:\n  global:\n    -\n      secure: longuglyencryptedstringnumber1=\n    -\n      secure: longuglyencryptedstringnumber2=\nlanguage: ruby\nrvm:\n  - \"2.0.0\"\n</code></pre>\n<p>It's probably best if you avert your gaze from those <em>after</em>success_ lines, lest you be turned to stone. The real trick is interpolating that <em>$TRAVIS</em>COMMIT_ into the single-quoted JSON payload. If there's a less-hideous way of doing this, I'd really like to hear about it.</p>\n<p>In the course of debugging this (which took <a href=\"https://travis-ci.org/theodi/such-travis/builds\">way longer than it should have</a>), I was pointed towards the brilliant <a href=\"http://requestb.in/\">requestb.in</a> HTTP-request-inspection tool (thanks <a href=\"http://theodi.org/team/james-smith\">James</a>), without which I may have simply thrown in the towel. Also, <a href=\"http://yamllint.com/\">YAMLlint</a> is pretty nice.</p>\n<p>Hope this spares somebody else the pain I've been through this morning.</p>","media_enquiries_name":"","media_enquiries_email":"","media_enquiries_telephone":"","organizations":[],"author":{}},"related_external_links":[],"related":[],"organizations":[],"author":{}}